/**
 * Code.gs ‚Äî –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (Google Apps Script)
 *
 * –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–æ–º —Ä–µ–ª–∏–∑–µ:
 * - –ó–∞–∫—Ä—ã—Ç—ã –ø—É–±–ª–∏—á–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã: getTableData, getRegistrationRequests, getUserByEmail
 * - –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω–æ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã: getRegistrationRequestsWithToken, getUserByEmailWithToken
 * - getTableData –≤—ã–Ω–µ—Å–µ–Ω –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π _getTableDataInternal –∏ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ getTableDataWithToken
 * - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ email —Å–¥–µ–ª–∞–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º –≤ checkAuth –∏ validateSession
 * - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –Ω–∞ —á—Ç–µ–Ω–∏–∏ –∞—É–¥–∏—Ç–∞ (isAllowedAuditAction)
 * - –ú–µ–ª–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
 */

const SCRIPT_PROPERTIES = PropertiesService.getScriptProperties();
const CACHE = CacheService.getScriptCache();

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
const SESSION_TTL_SECONDS = 30 * 60; // 30 –º–∏–Ω—É—Ç
const HEADERS_CACHE_TTL = 60 * 60;   // 1 —á–∞—Å
const AUTH_ATTEMPT_LIMIT = 10;       // –º–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ per-email –∑–∞ –æ–∫–Ω–æ
const AUTH_ATTEMPT_TTL = 5 * 60;     // –æ–∫–Ω–æ –ø–æ–ø—ã—Ç–æ–∫ (—Å–µ–∫)
const AUTH_GLOBAL_ATTEMPT_LIMIT = 50;// –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–µ–ª –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ –æ–∫–Ω–æ
const MAX_CELL_LEN = 2000;           // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —è—á–µ–π–∫–∏ –ø—Ä–∏ updateTableData

// –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∞—É–¥–∏—Ç–∞: —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) –∏ –∑–∞—è–≤–∫–∏ (–ø—Ä–∏–Ω—è—Ç–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ)
function isAllowedAuditAction(action) {
  const a = String(action || '').trim().toLowerCase();
  return a === 'update_table' || a === 'approve' || a === 'reject';
}

/**
 * doGet - –æ—Ç–¥–∞—ë—Ç –∫–ª–∏–µ–Ω—Ç (index.html)
 */
function doGet(e) {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

/* ----------------------------
   –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
   ---------------------------- */

function getSettings() {
  let settings = SCRIPT_PROPERTIES.getProperties();
  if (Object.keys(settings).length === 0) {
    settings = {
      USERS_SHEET_NAME: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
      SETTINGS_SHEET_NAME: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
      REG_REQUESTS_SHEET_NAME: '–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é',
      AUDIT_SHEET_NAME: 'Audit',
      DATA_SHEET_NAME_PROPERTY: '–õ–∏—Å—Ç',
      DATA_RANGE_PROPERTY: '–î–∏–∞–ø–∞–∑–æ–Ω'
    };
    SCRIPT_PROPERTIES.setProperties(settings);
  } else {
    if (!settings.REG_REQUESTS_SHEET_NAME) settings.REG_REQUESTS_SHEET_NAME = '–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é';
    if (!settings.AUDIT_SHEET_NAME) settings.AUDIT_SHEET_NAME = 'Audit';
    if (!settings.SETTINGS_SHEET_NAME) settings.SETTINGS_SHEET_NAME = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏';
  }
  return settings;
}

function initSheetsOnce() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const s = getSettings();

  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
  let usersSheet = ss.getSheetByName(s.USERS_SHEET_NAME);
  if (!usersSheet) {
    usersSheet = ss.insertSheet(s.USERS_SHEET_NAME);
    usersSheet.appendRow(['–≠–º–æ–¥–∑–∏', '–ò–º—è', '–†–æ–ª—å', '–¶–≤–µ—Ç', '–ü–æ—á—Ç–∞', '–ü–∞—Ä–æ–ª—å', '–û–ø–∏—Å–∞–Ω–∏–µ', '–ê–¥–º–∏–Ω']);
  } else {
    const vals = usersSheet.getDataRange().getValues();
    if (!vals || vals.length < 1) {
      usersSheet.clear();
      usersSheet.appendRow(['–≠–º–æ–¥–∑–∏', '–ò–º—è', '–†–æ–ª—å', '–¶–≤–µ—Ç', '–ü–æ—á—Ç–∞', '–ü–∞—Ä–æ–ª—å', '–û–ø–∏—Å–∞–Ω–∏–µ', '–ê–¥–º–∏–Ω']);
    }
  }

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  let settingsSheet = ss.getSheetByName(s.SETTINGS_SHEET_NAME);
  if (!settingsSheet) {
    settingsSheet = ss.insertSheet(s.SETTINGS_SHEET_NAME);
    settingsSheet.appendRow([s.DATA_SHEET_NAME_PROPERTY, s.DATA_RANGE_PROPERTY]);
    settingsSheet.appendRow(['–î–∞–Ω–Ω—ã–µ', 'A1:C10']);
  } else {
    const vals = settingsSheet.getDataRange().getValues();
    if (!vals || vals.length < 2) {
      settingsSheet.clear();
      settingsSheet.appendRow([s.DATA_SHEET_NAME_PROPERTY, s.DATA_RANGE_PROPERTY]);
      settingsSheet.appendRow(['–î–∞–Ω–Ω—ã–µ', 'A1:C10']);
    }
  }

  // Audit
  let audit = ss.getSheetByName(s.AUDIT_SHEET_NAME);
  if (!audit) {
    audit = ss.insertSheet(s.AUDIT_SHEET_NAME);
    audit.appendRow(['Timestamp', 'Actor', 'Action', 'Target', 'Details']);
  }

  // –ó–∞—è–≤–∫–∏
  let req = ss.getSheetByName(s.REG_REQUESTS_SHEET_NAME);
  if (!req) {
    req = ss.insertSheet(s.REG_REQUESTS_SHEET_NAME);
    req.appendRow(['–≠–º–æ–¥–∑–∏', '–ò–º—è', '–†–æ–ª—å', '–¶–≤–µ—Ç', '–ü–æ—á—Ç–∞', '–ü–∞—Ä–æ–ª—å', '–û–ø–∏—Å–∞–Ω–∏–µ', '–ê–¥–º–∏–Ω']);
  }
}

function findOrNormalizeRequestsSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const s = getSettings();
  const canonical = s.REG_REQUESTS_SHEET_NAME;

  // –ï—Å–ª–∏ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –ª–∏—Å—Ç –µ—Å—Ç—å ‚Äî –≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ
  let exact = ss.getSheetByName(canonical);
  if (exact) return exact;

  // –ò–Ω–∞—á–µ ‚Äî –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ª–∏—Å—Ç –ø–æ —à–∞–±–ª–æ–Ω—É, –ù–ï –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—è
  const all = ss.getSheets();
  const regex = /–∑–∞—è–≤–∫|–∑–∞–ø—Ä–æ—Å|request|registration/i;
  for (let i = 0; i < all.length; i++) {
    const name = all[i].getName();
    if (regex.test(name)) {
      return all[i];
    }
  }

  // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π
  const newSheet = ss.insertSheet(canonical);
  newSheet.appendRow(['–≠–º–æ–¥–∑–∏', '–ò–º—è', '–†–æ–ª—å', '–¶–≤–µ—Ç', '–ü–æ—á—Ç–∞', '–ü–∞—Ä–æ–ª—å', '–û–ø–∏—Å–∞–Ω–∏–µ', '–ê–¥–º–∏–Ω']);
  return newSheet;
}

function ensureSheetsInitialized() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const s = getSettings();
  const flag = SCRIPT_PROPERTIES.getProperty('SHEETS_INITIALIZED') === 'true';

  if (flag) {
    const need = [s.USERS_SHEET_NAME, s.SETTINGS_SHEET_NAME, s.REG_REQUESTS_SHEET_NAME, s.AUDIT_SHEET_NAME];
    let allPresent = true;
    for (let i = 0; i < need.length; i++) {
      if (!ss.getSheetByName(need[i])) {
        allPresent = false;
        break;
      }
    }
    if (allPresent) return;
  }

  initSheetsOnce();
  findOrNormalizeRequestsSheet();
  SCRIPT_PROPERTIES.setProperty('SHEETS_INITIALIZED', 'true');
}

/* ----------------------------
   –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —á—Ç–µ–Ω–∏—è / –∫—ç—à –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
   ---------------------------- */

function getSheetHeaders(sheetName) {
  const cacheKey = 'headers_' + sheetName;
  const cached = CACHE.get(cacheKey);
  if (cached) {
    try { return JSON.parse(cached); } catch (e) {}
  }
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return [];
  const lastCol = Math.max(1, sheet.getLastColumn() || 1);
  const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0].map(h => String(h || '').trim());
  CACHE.put(cacheKey, JSON.stringify(headers), HEADERS_CACHE_TTL);
  return headers;
}

function readSheetDataRows(sheetName) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return [];
  const lastRow = sheet.getLastRow();
  const lastCol = Math.max(1, sheet.getLastColumn() || 1);
  if (lastRow < 2) return [];
  const numRows = lastRow - 1;
  return sheet.getRange(2, 1, numRows, lastCol).getValues();
}

/* ----------------------------
   Validation, sanitization & helpers
   ---------------------------- */

function isValidEmail(email) {
  if (!email || typeof email !== 'string') return false;
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim());
}

function sanitizeString(s, maxLen) {
  if (s == null) return '';
  let str = String(s);
  // —É–±—Ä–∞—Ç—å —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ
  str = str.replace(/[\x00-\x1F\x7F]/g, '');
  if (maxLen && str.length > maxLen) str = str.substring(0, maxLen);
  return str;
}

function neutralizeFormulaCell(v) {
  // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å = + - @ ‚Äî –ø—Ä–µ–≤—Ä–∞—Ç–∏–º –≤ —Ç–µ–∫—Å—Ç (–∞–ø–æ—Å—Ç—Ä–æ—Ñ)
  if (v == null) return '';
  let s = String(v);
  if (/^[=+\-@]/.test(s)) return "'" + s;
  return s;
}

function truncateGraphemes(s, max) {
  const arr = Array.from(String(s || ''));
  return arr.slice(0, max).join('');
}

function normalizeHexColor(v) {
  const s = String(v || '').trim();
  if (/^#([0-9a-fA-F]{6})$/.test(s)) return s;
  if (/^[0-9a-fA-F]{6}$/.test(s)) return '#' + s;
  if (/^#([0-9a-fA-F]{3})$/.test(s)) return '#' + s.slice(1).split('').map(ch => ch + ch).join('');
  if (/^[0-9a-fA-F]{3}$/.test(s)) return '#' + s.split('').map(ch => ch + ch).join('');
  return '';
}

function valueByHeader(headers, row, headerName, defVal) {
  const idx = headers.indexOf(headerName);
  if (idx === -1) return defVal;
  return row[idx] == null ? defVal : row[idx];
}

function findHeaderIndex(headers, variants) {
  const lc = headers.map(h => String(h || '').trim().toLowerCase());
  for (let v of variants) {
    const idx = lc.indexOf(String(v || '').trim().toLowerCase());
    if (idx !== -1) return idx;
  }
  return -1;
}

/* ----------------------------
   Session token management (+ logout/blacklist + bulk invalidation)
   ---------------------------- */

function createSessionToken(email) {
  if (!email) return null;
  const token = Utilities.getUuid();
  const sessionKey = 'session_' + token;
  const createdKey = 'session_created_' + token;
  const nowTs = Date.now().toString();
  try {
    CACHE.put(sessionKey, String(email).trim().toLowerCase(), SESSION_TTL_SECONDS);
    CACHE.put(createdKey, nowTs, SESSION_TTL_SECONDS);
  } catch (e) {
    console.error('createSessionToken cache error: ' + e.message);
  }
  try { logAudit(email, 'create_session', token, 'session created'); } catch (e) {}
  return token;
}

function validateSessionToken(token) {
  if (!token || typeof token !== 'string') return { valid: false, email: null, isAdmin: false };

  const blackKey = 'black_' + token;
  try {
    if (CACHE.get(blackKey)) {
      return { valid: false, email: null, isAdmin: false };
    }
  } catch (e) {
    console.error('validateSessionToken blackKey error: ' + e.message);
  }

  const sessionKey = 'session_' + token;
  const createdKey = 'session_created_' + token;
  const email = CACHE.get(sessionKey);
  if (!email) {
    return { valid: false, email: null, isAdmin: false };
  }

  let createdTs = null;
  try { createdTs = CACHE.get(createdKey); } catch (e) { console.error('validateSessionToken createdKey error: ' + e.message); }

  try {
    const killKey = 'sessions_killed_' + String(email);
    const killedStr = SCRIPT_PROPERTIES.getProperty(killKey);
    if (killedStr && createdTs) {
      const killedTs = parseInt(killedStr, 10);
      const createdNum = parseInt(createdTs, 10);
      if (!isNaN(killedTs) && !isNaN(createdNum) && createdNum <= killedTs) {
        return { valid: false, email: null, isAdmin: false };
      }
    }
  } catch (e) {
    console.error('validateSessionToken bulk kill check error: ' + e.message);
  }

  const vs = validateSession(email);
  if (!vs.valid) return { valid: false, email: null, isAdmin: false };

  try {
    CACHE.put(sessionKey, String(email), SESSION_TTL_SECONDS);
    if (createdTs) CACHE.put(createdKey, String(createdTs), SESSION_TTL_SECONDS);
  } catch (e) {
    console.error('validateSessionToken extend TTL error: ' + e.message);
  }

  return { valid: true, email: email, isAdmin: vs.isAdmin };
}

function logout(token) {
  if (!token || typeof token !== 'string') return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω' };

  const sessionKey = 'session_' + token;
  const createdKey = 'session_created_' + token;
  const blackKey = 'black_' + token;

  let email = null;
  try { email = CACHE.get(sessionKey) || null; } catch (e) { console.error('logout read session error: ' + e.message); }

  try { CACHE.remove(sessionKey); } catch (e) { console.error('logout remove session error: ' + e.message); }
  try { CACHE.remove(createdKey); } catch (e) { console.error('logout remove created error: ' + e.message); }
  try { CACHE.put(blackKey, '1', SESSION_TTL_SECONDS); } catch (e) { console.error('logout put black error: ' + e.message); }

  try { logAudit(email || 'unknown', 'logout', token, 'token invalidated'); } catch (e) {}
  return { success: true };
}

function invalidateAllSessionsForUser(email) {
  if (!email || !isValidEmail(email)) return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π email' };
  const key = 'sessions_killed_' + String(email).trim().toLowerCase();
  const now = Date.now().toString();
  try {
    SCRIPT_PROPERTIES.setProperty(key, now);
    logAudit(email, 'invalidate_all_sessions', '', 'all sessions invalidated at ' + now);
    return { success: true };
  } catch (e) {
    console.error('invalidateAllSessionsForUser error: ' + e.message);
    return { success: false, error: e.message };
  }
}

/* ----------------------------
   Audit log (best-effort) ‚Äî –ø–∏—à–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
   ---------------------------- */

function logAudit(actor, action, target, details) {
  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –≤ –ª–æ–≥ —É—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ update_table / approve / reject
  if (!isAllowedAuditAction(action)) return;

  try {
    const s = getSettings();
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(s.AUDIT_SHEET_NAME);
    if (!sheet) {
      sheet = ss.insertSheet(s.AUDIT_SHEET_NAME);
      sheet.appendRow(['Timestamp', 'Actor', 'Action', 'Target', 'Details']);
    }
    const lock = LockService.getScriptLock();
    lock.waitLock(5000);
    try {
      const ts = new Date();
      sheet.appendRow([ts.toISOString(), actor || '', action || '', target || '', details || '']);
    } finally {
      try { lock.releaseLock(); } catch (e) {}
    }
  } catch (e) {
    console.error('logAudit error: ' + e.message);
  }
}

/* ----------------------------
   Rate limiting helpers (cache-based)
   ---------------------------- */

function isAuthBlocked(email) {
  const key = 'auth_attempts_' + String(email).trim().toLowerCase();
  const attempts = parseInt(CACHE.get(key) || '0', 10) || 0;
  return attempts >= AUTH_ATTEMPT_LIMIT;
}
function recordAuthFailure(email) {
  const key = 'auth_attempts_' + String(email).trim().toLowerCase();
  const attempts = parseInt(CACHE.get(key) || '0', 10) || 0;
  CACHE.put(key, (attempts + 1).toString(), AUTH_ATTEMPT_TTL);
}
function clearAuthFailures(email) {
  const key = 'auth_attempts_' + String(email).trim().toLowerCase();
  try { CACHE.remove(key); } catch (e) {}
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ –ø–µ—Ä—Å–æ–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É)
function isAuthGlobalBlocked() {
  const key = 'auth_attempts_global';
  const attempts = parseInt(CACHE.get(key) || '0', 10) || 0;
  return attempts >= AUTH_GLOBAL_ATTEMPT_LIMIT;
}
function recordAuthGlobalFailure() {
  const key = 'auth_attempts_global';
  const attempts = parseInt(CACHE.get(key) || '0', 10) || 0;
  CACHE.put(key, (attempts + 1).toString(), AUTH_ATTEMPT_TTL);
}

/* ----------------------------
   Authentication endpoint
   ---------------------------- */

function checkAuth(pochta, password) {
  ensureSheetsInitialized();

  if (!pochta || !password) return { authorized: false, error: '–¢—Ä–µ–±—É—é—Ç—Å—è –ø–æ—á—Ç–∞ –∏ –ø–∞—Ä–æ–ª—å' };
  if (!isValidEmail(pochta)) return { authorized: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ—á—Ç—ã' };

  // Rate limits
  if (isAuthGlobalBlocked()) {
    logAudit(pochta, 'auth_blocked', '', 'Too many attempts (global)');
    return { authorized: false, error: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' };
  }
  if (isAuthBlocked(pochta)) {
    logAudit(pochta, 'auth_blocked', '', 'Too many attempts (email)');
    return { authorized: false, error: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' };
  }

  const s = getSettings();
  const headers = getSheetHeaders(s.USERS_SHEET_NAME);

  const mailIdx = headers.indexOf('–ü–æ—á—Ç–∞');
  const passIdx = headers.indexOf('–ü–∞—Ä–æ–ª—å');
  const nameIdx = headers.indexOf('–ò–º—è');
  const roleIdx = headers.indexOf('–†–æ–ª—å');
  const adminIdx = headers.indexOf('–ê–¥–º–∏–Ω');

  if (mailIdx === -1 || passIdx === -1) {
    logAudit('system', 'login_failed', '', 'Users sheet missing required columns');
    return { authorized: false, error: '–õ–∏—Å—Ç "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" –ø–æ–≤—Ä–µ–∂–¥—ë–Ω (–Ω–µ—Ç –∫–æ–ª–æ–Ω–æ–∫ –ü–æ—á—Ç–∞/–ü–∞—Ä–æ–ª—å)' };
  }

  const rows = readSheetDataRows(s.USERS_SHEET_NAME);
  const inputMail = String(pochta).trim().toLowerCase();

  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    const mail = String(row[mailIdx] || '').trim().toLowerCase();
    if (mail === inputMail) {
      const stored = String(row[passIdx] || '');
      if (stored === String(password)) {
        clearAuthFailures(pochta);
        const isAdm = adminIdx !== -1 ? cellToBool(row[adminIdx]) : false;
        const token = createSessionToken(inputMail);
        const userName = nameIdx !== -1 ? row[nameIdx] : '';
        const userRole = roleIdx !== -1 ? row[roleIdx] : '';
        logAudit(inputMail, 'login_success', '', 'login OK');
        return { authorized: true, userName: userName, userRole: userRole, isAdmin: isAdm, token: token };
      } else {
        recordAuthFailure(pochta);
        recordAuthGlobalFailure();
        logAudit(inputMail, 'login_failed', '', 'invalid password');
        return { authorized: false, error: '–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ—á—Ç–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—å' };
      }
    }
  }

  recordAuthFailure(pochta);
  recordAuthGlobalFailure();
  logAudit(inputMail, 'login_failed', '', 'email not found');
  return { authorized: false, error: '–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ—á—Ç–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—å' };
}

/* ----------------------------
   Session validation (users)
   ---------------------------- */

function validateSession(pochta) {
  ensureSheetsInitialized();
  if (!pochta) return { valid: false, isAdmin: false };
  const s = getSettings();
  const headers = getSheetHeaders(s.USERS_SHEET_NAME);
  const mailIdx = headers.indexOf('–ü–æ—á—Ç–∞');
  const adminIdx = headers.indexOf('–ê–¥–º–∏–Ω');

  if (mailIdx === -1) return { valid: false, isAdmin: false };

  const rows = readSheetDataRows(s.USERS_SHEET_NAME);
  const inputMail = String(pochta).trim().toLowerCase();

  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    if (String(row[mailIdx] || '').trim().toLowerCase() === inputMail) {
      return { valid: true, isAdmin: adminIdx !== -1 ? cellToBool(row[adminIdx]) : false };
    }
  }
  return { valid: false, isAdmin: false };
}

/* ----------------------------
   Public users with pagination (—Ü–≤–µ—Ç —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ —è—á–µ–π–∫–∏ –∏–ª–∏ —Ñ–æ–Ω–∞)
   ---------------------------- */

function getPublicUserDataPage(page, pageSize) {
  ensureSheetsInitialized();
  page = Math.max(1, parseInt(page, 10) || 1);
  pageSize = Math.max(1, Math.min(200, parseInt(pageSize, 10) || 50));

  const s = getSettings();
  const headers = getSheetHeaders(s.USERS_SHEET_NAME);

  // –†–æ–±–∞—Å—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏—è–º
  const emojiIdx = findHeaderIndex(headers, ['–≠–º–æ–¥–∑–∏', 'emoji', 'emojis']);
  const nameIdx  = findHeaderIndex(headers, ['–ò–º—è', 'name']);
  const roleIdx  = findHeaderIndex(headers, ['–†–æ–ª—å', 'role']);
  const colorIdx = findHeaderIndex(headers, ['–¶–≤–µ—Ç', 'color', 'colour', '—Ü–≤–µ—Ç']);
  const mailIdx  = findHeaderIndex(headers, ['–ü–æ—á—Ç–∞', 'email', 'e-mail', 'mail']);
  const descIdx  = findHeaderIndex(headers, ['–û–ø–∏—Å–∞–Ω–∏–µ', 'description', 'desc']);

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(s.USERS_SHEET_NAME);
  if (!sheet) return { users: [], total: 0, page: page, pageSize: pageSize };

  const lastRow = sheet.getLastRow();
  const lastCol = Math.max(1, sheet.getLastColumn() || (headers.length || 1));
  const total = Math.max(0, lastRow - 1);
  if (total === 0) return { users: [], total: 0, page: page, pageSize: pageSize };

  const startIndex = (page - 1) * pageSize; // 0-based
  const startRow = 2 + startIndex;
  const readRows = Math.min(pageSize, lastRow - startRow + 1);

  let rows = [];
  let colorBackgrounds = null;
  if (readRows > 0) {
    rows = sheet.getRange(startRow, 1, readRows, lastCol).getValues();
    if (colorIdx !== -1) {
      const colorCol1 = colorIdx + 1;
      colorBackgrounds = sheet.getRange(startRow, colorCol1, readRows, 1).getBackgrounds(); // [[#rrggbb], ...]
    }
  }

  const users = rows.map((r, i) => {
    const emoji = emojiIdx !== -1 ? r[emojiIdx] : 'üë§';
    const name  = nameIdx  !== -1 ? r[nameIdx]  : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    const role  = roleIdx  !== -1 ? r[roleIdx]  : '–†–æ–ª—å';

    // 1) –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —è—á–µ–π–∫–∏; 2) —Ñ–æ–Ω —è—á–µ–π–∫–∏; 3) –¥–µ—Ñ–æ–ª—Ç
    let color = colorIdx !== -1 ? normalizeHexColor(r[colorIdx]) : '';
    if (!color && colorBackgrounds && colorBackgrounds[i] && colorBackgrounds[i][0]) {
      const bgHex = normalizeHexColor(colorBackgrounds[i][0]);
      if (bgHex && bgHex.toLowerCase() !== '#ffffff') {
        color = bgHex;
      }
    }
    if (!color) color = '#5865F2';

    const email = mailIdx !== -1 ? r[mailIdx] : '';
    const desc  = descIdx !== -1 ? r[descIdx] : '';
    return [emoji || 'üë§', name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', role || '–†–æ–ª—å', color, email || '', desc || ''];
  });

  return { users: users, total: total, page: page, pageSize: pageSize };
}

/* ----------------------------
   Robust getTableData (private) + tokenized reader
   ---------------------------- */

function _getTableDataInternal() {
  const s = getSettings();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const settingsSheet = ss.getSheetByName(s.SETTINGS_SHEET_NAME);
  if (!settingsSheet) {
    return { error: '–õ–∏—Å—Ç "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" –Ω–µ –Ω–∞–π–¥–µ–Ω' };
  }

  try {
    const vals = settingsSheet.getRange(2, 1, 1, 2).getValues();
    if (!vals || !vals[0]) {
      return { error: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã. –£–∫–∞–∂–∏—Ç–µ –ª–∏—Å—Ç –∏ –¥–∏–∞–ø–∞–∑–æ–Ω –≤ –ª–∏—Å—Ç–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"' };
    }
    const sheetName = String(vals[0][0] || '').trim();
    const range = String(vals[0][1] || '').trim();
    if (!sheetName) return { error: '–ò–º—è –ª–∏—Å—Ç–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—É—Å—Ç–æ' };
    if (!range) return { error: '–î–∏–∞–ø–∞–∑–æ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—É—Å—Ç' };

    const dataSheet = ss.getSheetByName(sheetName);
    if (!dataSheet) return { error: `–õ–∏—Å—Ç "${sheetName}" –Ω–µ –Ω–∞–π–¥–µ–Ω` };

    let data;
    try {
      const rng = dataSheet.getRange(range);
      const numRows = rng.getNumRows();
      const numCols = rng.getNumColumns();
      if (numRows <= 0 || numCols <= 0) return { error: '–£–∫–∞–∑–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø—É—Å—Ç' };
      data = rng.getValues();
    } catch (e) {
      return { error: `–û—à–∏–±–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ "${range}": ${e.message}` };
    }
    return { data: data, settings: { sheetName: sheetName, range: range } };
  } catch (e) {
    return { error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + e.message };
  }
}

// –°—Ç–∞—Ä—ã–π –ø—É–±–ª–∏—á–Ω—ã–π —Ä–∏–¥–µ—Ä –∑–∞–∫—Ä—ã—Ç
function getTableData() {
  return { error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ' };
}

// –ù–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç: —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º)
function getTableDataWithToken(token) {
  ensureSheetsInitialized();
  const vt = validateSessionToken(token);
  if (!vt.valid) return { error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ' };
  return _getTableDataInternal();
}

/* ----------------------------
   Registration requests & admin actions
   ---------------------------- */

// –°—Ç–∞—Ä—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –≤—ã–∑–æ–≤ –∑–∞–∫—Ä—ã—Ç
function getRegistrationRequests() {
  return { error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ' };
}

// –ù–æ–≤—ã–π –∑–∞—â–∏—â—ë–Ω–Ω—ã–π –≤—ã–∑–æ–≤
function getRegistrationRequestsWithToken(token) {
  ensureSheetsInitialized();
  const vt = validateSessionToken(token);
  if (!vt.valid || !vt.isAdmin) return { error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ' };

  const sheet = findOrNormalizeRequestsSheet();
  if (!sheet) return { error: '–õ–∏—Å—Ç –∑–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω' };

  const headers = getSheetHeaders(sheet.getName());
  const emojiIdx = headers.indexOf('–≠–º–æ–¥–∑–∏');
  const nameIdx = headers.indexOf('–ò–º—è');
  const roleIdx = headers.indexOf('–†–æ–ª—å');
  const colorIdx = headers.indexOf('–¶–≤–µ—Ç');
  const mailIdx = headers.indexOf('–ü–æ—á—Ç–∞');
  const descIdx = headers.indexOf('–û–ø–∏—Å–∞–Ω–∏–µ');
  const adminIdx = headers.indexOf('–ê–¥–º–∏–Ω');

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return { requests: [] };
  const lastCol = Math.max(1, sheet.getLastColumn() || 1);
  const rows = sheet.getRange(2, 1, lastRow - 1, lastCol).getValues();

  const requests = [];
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    requests.push({
      _row: i + 2,
      emoji: emojiIdx !== -1 ? row[emojiIdx] : 'üë§',
      name: nameIdx !== -1 ? row[nameIdx] : '',
      role: roleIdx !== -1 ? row[roleIdx] : '',
      color: colorIdx !== -1 ? row[colorIdx] : '#5865F2',
      email: mailIdx !== -1 ? row[mailIdx] : '',
      description: descIdx !== -1 ? row[descIdx] : '',
      isAdmin: adminIdx !== -1 ? cellToBool(row[adminIdx]) : false
    });
  }
  return { requests };
}

function approveRegistrationRequest(token, requestRow) {
  ensureSheetsInitialized();
  const vt = validateSessionToken(token);
  if (!vt.valid || !vt.isAdmin) {
    logAudit(vt.email || 'unknown', 'approve_failed', requestRow, 'not authorized');
    return { success: false, error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ' };
  }

  requestRow = parseInt(requestRow, 10);
  if (!requestRow || requestRow < 2) return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏' };

  const reqSheet = findOrNormalizeRequestsSheet();
  if (!reqSheet) return { success: false, error: '–õ–∏—Å—Ç –∑–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω' };

  const headers = getSheetHeaders(reqSheet.getName());
  const numCols = Math.max(1, headers.length || reqSheet.getLastColumn() || 1);
  try {
    const rowData = reqSheet.getRange(requestRow, 1, 1, numCols).getValues()[0];

    const userData = {
      emoji: sanitizeString(valueByHeader(headers, rowData, '–≠–º–æ–¥–∑–∏', 'üë§'), 16),
      name: sanitizeString(valueByHeader(headers, rowData, '–ò–º—è', ''), 100),
      role: sanitizeString(valueByHeader(headers, rowData, '–†–æ–ª—å', ''), 50),
      color: normalizeHexColor(valueByHeader(headers, rowData, '–¶–≤–µ—Ç', '#5865F2')) || '#5865F2',
      email: sanitizeString(valueByHeader(headers, rowData, '–ü–æ—á—Ç–∞', ''), 200),
      password: sanitizeString(valueByHeader(headers, rowData, '–ü–∞—Ä–æ–ª—å', ''), 200),
      description: sanitizeString(valueByHeader(headers, rowData, '–û–ø–∏—Å–∞–Ω–∏–µ', ''), 1000),
      isAdmin: cellToBool(valueByHeader(headers, rowData, '–ê–¥–º–∏–Ω', false))
    };

    if (!isValidEmail(userData.email)) {
      return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π email –≤ –∑–∞—è–≤–∫–µ' };
    }

    // –ù–µ–π—Ç—Ä–∞–ª–∏–∑—É–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã
    userData.emoji = truncateGraphemes(neutralizeFormulaCell(userData.emoji), 8);
    userData.name = neutralizeFormulaCell(userData.name);
    userData.role = neutralizeFormulaCell(userData.role);
    userData.description = neutralizeFormulaCell(userData.description);
    userData.password = neutralizeFormulaCell(userData.password);

    const addResult = addNewUser(userData);
    if (!addResult.success) {
      logAudit(vt.email, 'approve_failed', userData.email, String(addResult.error));
      return { success: false, error: '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + addResult.error };
    }

    const lock = LockService.getScriptLock();
    lock.waitLock(10000);
    try {
      reqSheet.deleteRow(requestRow);
    } finally {
      try { lock.releaseLock(); } catch (e) {}
    }

    logAudit(vt.email, 'approve', userData.email, 'approved request row ' + requestRow);
    return { success: true, message: '–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω' };
  } catch (e) {
    logAudit(vt.email, 'approve_error', requestRow, e.message);
    return { success: false, error: e.message };
  }
}

function rejectRegistrationRequest(token, requestRow) {
  ensureSheetsInitialized();
  const vt = validateSessionToken(token);
  if (!vt.valid || !vt.isAdmin) {
    logAudit(vt.email || 'unknown', 'reject_failed', requestRow, 'not authorized');
    return { success: false, error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ' };
  }

  requestRow = parseInt(requestRow, 10);
  if (!requestRow || requestRow < 2) return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏' };

  const reqSheet = findOrNormalizeRequestsSheet();
  if (!reqSheet) return { success: false, error: '–õ–∏—Å—Ç –∑–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω' };

  try {
    const headers = getSheetHeaders(reqSheet.getName());
    const numCols = Math.max(1, headers.length || reqSheet.getLastColumn() || 1);
    const lock = LockService.getScriptLock();
    lock.waitLock(10000);
    try {
      const rowData = reqSheet.getRange(requestRow, 1, 1, numCols).getValues()[0];
      const targetEmail = String(valueByHeader(headers, rowData, '–ü–æ—á—Ç–∞', '') || '');
      reqSheet.deleteRow(requestRow);
      logAudit(vt.email, 'reject', targetEmail || ('row:' + requestRow), 'rejected and deleted');
    } finally {
      try { lock.releaseLock(); } catch (e) {}
    }
    return { success: true, message: '–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∏ —É–¥–∞–ª–µ–Ω–∞' };
  } catch (e) {
    logAudit(vt.email, 'reject_error', requestRow, e.message);
    return { success: false, error: e.message };
  }
}

/* ----------------------------
   Update table data (admin-protected) + –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –æ—Ç–ª–∏—á–∏–π
   –†–∞–∑—Ä–µ—à–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –¥–∏–∞–ø–∞–∑–æ–Ω–∞; –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∑–∞—â–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É 1 –ª–∏—Å—Ç–∞ Users.
   ---------------------------- */

function updateTableDataWithToken(token, sheetName, range, newData) {
  ensureSheetsInitialized();
  const vt = validateSessionToken(token);
  if (!vt.valid || !vt.isAdmin) return { success: false, error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ' };

  if (!sheetName || !range || !Array.isArray(newData) || newData.length === 0) {
    return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' };
  }
  for (let i = 0; i < newData.length; i++) {
    if (!Array.isArray(newData[i])) return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç newData' };
  }

  try {
    const s = getSettings();
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) return { success: false, error: `–õ–∏—Å—Ç "${sheetName}" –Ω–µ –Ω–∞–π–¥–µ–Ω` };

    const dataRange = sheet.getRange(range);
    const rngRows = dataRange.getNumRows();
    const rngCols = dataRange.getNumColumns();

    if (newData.length !== rngRows) {
      return { success: false, error: `–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä—è–¥–∞–º. –û–∂–∏–¥–∞–ª–æ—Å—å ${rngRows}, –ø–æ–ª—É—á–µ–Ω–æ ${newData.length}` };
    }
    if (!newData.every(r => Array.isArray(r) && r.length === rngCols)) {
      return { success: false, error: `–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–æ–Ω–∫–∞–º. –û–∂–∏–¥–∞–ª–æ—Å—å –ø–æ ${rngCols} –∑–Ω–∞—á–µ–Ω–∏–π –≤ —Å—Ç—Ä–æ–∫–∞—Ö` };
    }

    const headers = getSheetHeaders(sheetName);
    const colorHeaderIdx0 = findHeaderIndex(headers, ['–¶–≤–µ—Ç','color','colour','—Ü–≤–µ—Ç']);
    const colorColAbs1 = colorHeaderIdx0 >= 0 ? (colorHeaderIdx0 + 1) : -1;

    const rangeStartRow1 = dataRange.getRow();
    const rangeStartCol1 = dataRange.getColumn();
    const sheetIsUsers = sheetName === s.USERS_SHEET_NAME;

    // –†–∞–∑—Ä–µ—à–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (UI –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
    const protectFirstRowOfRange = false;

    const colorInRange = colorColAbs1 >= rangeStartCol1 && colorColAbs1 <= (rangeStartCol1 + rngCols - 1);
    const colorRelIdx = colorInRange ? (colorColAbs1 - rangeStartCol1) : -1;

    const oldValues = dataRange.getValues();

    const diffs = [];
    const maxDiffs = 100;
    const trunc = (v) => {
      const sVal = String(v == null ? '' : v);
      return sVal.length > 200 ? sVal.slice(0, 200) + '‚Ä¶' : sVal;
    };

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è/—Å–∞–Ω–∏—Ç–∞–π–∑ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∑–∞—â–∏—Ç–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –õ–ò–°–¢–ê Users
    for (let i = 0; i < newData.length; i++) {
      const isHeaderOfRange = (protectFirstRowOfRange && i === 0);
      const isFirstRowOfUsers = (sheetIsUsers && (rangeStartRow1 + i) === 1);

      if (isHeaderOfRange || isFirstRowOfUsers) {
        newData[i] = oldValues[i];
        continue;
      }

      const row = newData[i];
      for (let j = 0; j < row.length; j++) {
        // –ó–∞–ø—Ä–µ—Ç —Ñ–æ—Ä–º—É–ª: —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º = + - @
        if (typeof row[j] === 'string') {
          let cell = neutralizeFormulaCell(row[j].trim());
          row[j] = sanitizeString(cell, MAX_CELL_LEN);
        } else {
          row[j] = sanitizeString(row[j], MAX_CELL_LEN);
        }
      }
      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ü–≤–µ—Ç–∞
      if (colorRelIdx >= 0) {
        const norm = normalizeHexColor(row[colorRelIdx]);
        row[colorRelIdx] = norm || '#5865F2';
      }
    }

    // –°–±–æ—Ä –¥–∏—Ñ—Ñ–æ–≤
    for (let i = 0; i < newData.length && diffs.length < maxDiffs; i++) {
      const isHeaderOfRange = (protectFirstRowOfRange && i === 0);
      const isFirstRowOfUsers = (sheetIsUsers && (rangeStartRow1 + i) === 1);
      if (isHeaderOfRange || isFirstRowOfUsers) continue;

      for (let j = 0; j < newData[i].length && diffs.length < maxDiffs; j++) {
        const before = oldValues[i][j];
        const after = newData[i][j];
        if (before !== after) {
          const a1 = sheet.getRange(rangeStartRow1 + i, rangeStartCol1 + j, 1, 1).getA1Notation();
          diffs.push(`${a1}: "${trunc(before)}" -> "${trunc(after)}"`);
        }
      }
    }

    const lock = LockService.getScriptLock();
    lock.waitLock(10000);
    try {
      dataRange.setValues(newData);
    } finally {
      lock.releaseLock();
    }

    // –°–±—Ä–æ—Å –∫—ç—à–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
    CACHE.remove('headers_' + sheetName);

    const details = diffs.length ? `changed ${diffs.length} cells:\n` + diffs.join('\n') : 'no-op';
    logAudit(vt.email, 'update_table', `${sheetName}:${range}`, details);
    return { success: true, message: '–î–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã' };
  } catch (e) {
    logAudit(vt.email, 'update_table_error', `${sheetName}:${range}`, e.message);
    return { success: false, error: e.message };
  }
}

/* ----------------------------
   Users operations
   ---------------------------- */

function safeAppendRow(sheet, rowArr) {
  const lock = LockService.getScriptLock();
  lock.waitLock(10000);
  try {
    sheet.appendRow(rowArr);
  } finally {
    try { lock.releaseLock(); } catch (e) {}
  }
}

function addNewUser(userData) {
  ensureSheetsInitialized();

  if (!userData || !userData.email) return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' };
  if (!isValidEmail(userData.email)) return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π email' };

  const s = getSettings();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(s.USERS_SHEET_NAME);
  if (!sheet) return { success: false, error: '–õ–∏—Å—Ç "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" –Ω–µ –Ω–∞–π–¥–µ–Ω' };

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π + –Ω–µ–π—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—É–ª
  const emojiSafe = truncateGraphemes(neutralizeFormulaCell(userData.emoji || 'üë§'), 8);
  const nameSafe = neutralizeFormulaCell(userData.name || '');
  const roleSafe = neutralizeFormulaCell(userData.role || '');
  const colorSafe = normalizeHexColor(userData.color || '#5865F2') || '#5865F2';
  const emailSafe = neutralizeFormulaCell(String(userData.email || '').trim().toLowerCase());
  const passSafe  = neutralizeFormulaCell(userData.password || '');
  const descSafe  = neutralizeFormulaCell(userData.description || '');
  const isAdmin   = userData.isAdmin ? true : false;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email –ø–æ–¥ –æ–±—â–∏–º ScriptLock (–∏—Å–∫–ª—é—á–∞–µ–º –≥–æ–Ω–∫–∏)
  const lock = LockService.getScriptLock();
  lock.waitLock(10000);
  try {
    const headers = getSheetHeaders(s.USERS_SHEET_NAME);
    const mailIdx = headers.indexOf('–ü–æ—á—Ç–∞');
    if (mailIdx === -1) {
      return { success: false, error: '–õ–∏—Å—Ç "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" –ø–æ–≤—Ä–µ–∂–¥—ë–Ω (–Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ "–ü–æ—á—Ç–∞")' };
    }

    const exists = readSheetDataRows(s.USERS_SHEET_NAME).some(r =>
      String(r[mailIdx] || '').trim().toLowerCase() === String(emailSafe || '').trim().toLowerCase()
    );
    if (exists) return { success: false, error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–æ–π –ø–æ—á—Ç–æ–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' };

    const row = [
      sanitizeString(emojiSafe, 8),
      sanitizeString(nameSafe, 100),
      sanitizeString(roleSafe, 50),
      sanitizeString(colorSafe, 20),
      sanitizeString(emailSafe, 200),
      sanitizeString(passSafe, 200),
      sanitizeString(descSafe, 1000),
      isAdmin
    ];

    sheet.appendRow(row);
    logAudit(emailSafe, 'add_user', emailSafe, 'user added'); // –Ω–µ –ø–æ–ø–∞–¥—ë—Ç –≤ –∞—É–¥–∏—Ç (—Ñ–∏–ª—å—Ç—Ä –∑–∞–ø–∏—Å–∏), –Ω–∞ –±—É–¥—É—â–µ–µ
    return { success: true, message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω' };
  } catch (e) {
    return { success: false, error: e.message };
  } finally {
    try { lock.releaseLock(); } catch (e) {}
  }
}

/* ----------------------------
   User retrieval (secured)
   ---------------------------- */

// –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø—É–±–ª–∏—á–Ω—ã–π –≤—ã–∑–æ–≤
function getUserByEmail(pochta) {
  return null;
}

// –ù–æ–≤—ã–π –∑–∞—â–∏—â—ë–Ω–Ω—ã–π –≤—ã–∑–æ–≤: –Ω–µ-–∞–¥–º–∏–Ω—É ‚Äî —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
function getUserByEmailWithToken(token, pochta) {
  ensureSheetsInitialized();
  const vt = validateSessionToken(token);
  if (!vt.valid) return null;

  const requested = String(pochta || '').trim().toLowerCase();
  const caller = String(vt.email || '').trim().toLowerCase();

  if (!vt.isAdmin && requested !== caller) return null;

  const s = getSettings();
  const headers = getSheetHeaders(s.USERS_SHEET_NAME);
  const mailIdx = headers.indexOf('–ü–æ—á—Ç–∞');
  const emojiIdx = headers.indexOf('–≠–º–æ–¥–∑–∏');
  const nameIdx = headers.indexOf('–ò–º—è');
  const roleIdx = headers.indexOf('–†–æ–ª—å');
  const colorIdx = headers.indexOf('–¶–≤–µ—Ç');
  const descIdx = headers.indexOf('–û–ø–∏—Å–∞–Ω–∏–µ');
  const adminIdx = headers.indexOf('–ê–¥–º–∏–Ω');

  if (mailIdx === -1) return null;

  const rows = readSheetDataRows(s.USERS_SHEET_NAME);
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    if (String(row[mailIdx] || '').trim().toLowerCase() === requested) {
      return {
        emoji: emojiIdx !== -1 ? (row[emojiIdx] || 'üë§') : 'üë§',
        name: nameIdx !== -1 ? (row[nameIdx] || '') : '',
        role: roleIdx !== -1 ? (row[roleIdx] || '') : '',
        color: normalizeHexColor(colorIdx !== -1 ? row[colorIdx] : '') || '#5865F2',
        email: row[mailIdx] || '',
        description: descIdx !== -1 ? (row[descIdx] || '') : '',
        isAdmin: adminIdx !== -1 ? cellToBool(row[adminIdx]) : false
      };
    }
  }
  return null;
}

/* ----------------------------
   Audit logs endpoint (admin-protected) ‚Äî server-side filter
   ---------------------------- */

function getAuditLogsWithToken(token, page, pageSize) {
  ensureSheetsInitialized();
  const vt = validateSessionToken(token);
  if (!vt.valid || !vt.isAdmin) return { error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ' };

  page = Math.max(1, parseInt(page, 10) || 1);
  pageSize = Math.max(1, Math.min(500, parseInt(pageSize, 10) || 100));

  const s = getSettings();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(s.AUDIT_SHEET_NAME);
  if (!sheet) return { logs: [], total: 0, page, pageSize };

  const lastRow = sheet.getLastRow(); // —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
  const totalRows = Math.max(0, lastRow - 1);
  if (totalRows === 0) return { logs: [], total: 0, page, pageSize };

  const lastCol = Math.max(5, sheet.getLastColumn() || 5);

  const startIdx = (page - 1) * pageSize;  // 0-based
  const readRows = Math.min(pageSize, totalRows - startIdx);
  if (readRows <= 0) return { logs: [], total: totalRows, page, pageSize };

  const startRow = 2 + startIdx; // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const rows = sheet.getRange(startRow, 1, readRows, lastCol).getValues();

  // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
  const filtered = rows.filter(r => isAllowedAuditAction(r[2]));
  const logs = filtered.map(r => ({
    Timestamp: r[0] || '',
    Actor:     r[1] || '',
    Action:    r[2] || '',
    Target:    r[3] || '',
    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–ø—Ä–æ—â–∞–µ–º details –¥–æ Action; –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å r[4] –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π
    Details:   r[2] || ''
  }));

  // total –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –æ–±—â–µ–µ —á–∏—Å–ª–æ —Å—Ç—Ä–æ–∫ (–±–µ–∑ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –ø–æ–ª–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é)
  return { logs, total: totalRows, page, pageSize };
}

/* ----------------------------
   Helper: normalize value to boolean
   ---------------------------- */

function cellToBool(v) {
  if (v === true) return true;
  if (v === false) return false;
  if (typeof v === 'number') return v === 1;
  if (typeof v === 'string') {
    const s = v.trim().toLowerCase();
    return s === 'true' || s === '1' || s === '–¥–∞' || s === 'yes';
  }
  return false;
}

/* ----------------------------
   Session info endpoint for client bootstrapping
   ---------------------------- */

function getSessionInfo(token) {
  const vt = validateSessionToken(token);
  if (!vt.valid) return { valid: false };
  return { valid: true, email: vt.email, isAdmin: vt.isAdmin };
}

// –ù–æ–≤—ã–π –º–µ—Ç–æ–¥: —á—Ç–µ–Ω–∏–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∏–º–µ–Ω–∏ –ª–∏—Å—Ç–∞ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω—É
function getNamedTableDataWithToken(token, sheetName, range) {
  ensureSheetsInitialized();
  const vt = validateSessionToken(token);
  if (!vt.valid) return { error: '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ' };

  if (!sheetName || !range) return { error: '–ù–µ –∑–∞–¥–∞–Ω—ã –∏–º—è –ª–∏—Å—Ç–∞ –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω' };

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return { error: `–õ–∏—Å—Ç "${sheetName}" –Ω–µ –Ω–∞–π–¥–µ–Ω` };

  try {
    const rng = sheet.getRange(range);
    const values = rng.getValues();
    return { data: values, settings: { sheetName, range } };
  } catch (e) {
    return { error: `–û—à–∏–±–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ "${range}": ${e.message}` };
  }
}
